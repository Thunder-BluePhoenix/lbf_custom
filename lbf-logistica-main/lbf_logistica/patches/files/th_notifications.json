{
  "name": "Material Request Notification TH1",
  "owner": "Administrator",
  "modified_by": "Administrator",
  "docstatus": 0,
  "idx": 2,
  "archived": 0,
  "funnel_name": "Material Request Notification TH1",
  "funnel_type": "Private",
  "status": "published",
  "viewport": "{\"x\":-234.8615676810382,\"y\":246.07332916228245,\"zoom\":1.1486983381229965}",
  "variable_list": "[]",
  "assistant_form_fields": "{}",
  "doctype": "Funnel",
  "funnel_access": [],
  "funnel_definition": [
    {
      "name": "j2g2rcet4v",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 1,
      "data": "{\"doctype\":\"Material Request\",\"action\":\"after_insert\",\"submit\":true,\"variable_path_for_output\":\"\"}",
      "position": "{\"x\":585,\"y\":-120}",
      "type": "document_event_trigger",
      "id": "6xG08pb-28ylYWEwHqcaR",
      "element_type": "Trigger",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g2urt6i3",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 2,
      "data": "{\"node_label\":\"Material request time check\",\"python_code\":\"doc = variables[\\\"doc\\\"]\\n\\nmr = frappe.get_doc(\\\"Material Request\\\", doc[\\\"name\\\"])\\n\\n\\ntimeline_settings = frappe.get_doc(\\\"Notification and Timeline Settings\\\")\\n\\n#if not timeline_settings.start_time or not timeline_settings.ending_time:\\n#   return\\n\\ntransporter = mr.custom_transporter_name\\nsupplier = frappe.get_doc(\\\"Supplier\\\",transporter)\\nstart_time = frappe.utils.get_time(supplier.custom_cutoff_start_time)\\nend_time = frappe.utils.get_time(supplier.custom_cutoff_end_time)\\n\\nroles_time = [row.roles for row in timeline_settings.notification_for_request_select_roles]\\nroles_other_items = [row.roles for row in timeline_settings.notification_for_other_itemsselect_roles]\\ncurrent_time = frappe.utils.get_time(mr.creation)\\n\\nusers_with_roles_time = []\\nusers_with_roles_other_items = []\\nemail_list = []\\nemail_list_time = []\\nemail_list_other = []\\n\\nnotification_subject = []\\n\\nif not (start_time <= current_time <= end_time):\\n    notification_subject.append(\\\"Material Request created for Tyre Hotel but not submitted\\\")\\n    users_with_roles_time = frappe.db.get_all(\\n        \\\"Has Role\\\",\\n        filters={\\n            \\\"role\\\": [\\\"in\\\", roles_time],\\n            \\\"parenttype\\\": \\\"User\\\"\\n        },\\n        fields=[\\\"parent as user\\\"],\\n        distinct=True\\n    )\\n    usernames_time = [user.get(\\\"user\\\") for user in users_with_roles_time]\\n    emails_time = frappe.db.get_all(\\n        \\\"User\\\",\\n        filters={\\\"name\\\": [\\\"in\\\", usernames_time]},\\n        fields=[\\\"email\\\"]\\n    )\\n    email_list.extend([email.get(\\\"email\\\") for email in emails_time])\\n    email_list_time.extend([email.get(\\\"email\\\") for email in emails_time])\\n\\nif mr.custom_service == \\\"Tyre Hotel\\\":\\n    for item in mr.custom_th_items:\\n        if item.item_code.lower() in [\\\"others\\\", \\\"other\\\"]:\\n            notification_subject.append(\\\"Other Item detected in Material Request\\\")\\n            users_with_roles_other_items = frappe.db.get_all(\\n                \\\"Has Role\\\",\\n                filters={\\n                    \\\"role\\\": [\\\"in\\\", roles_other_items],\\n                    \\\"parenttype\\\": \\\"User\\\"\\n                },\\n                fields=[\\\"parent as user\\\"],\\n                distinct=True\\n            )\\n            usernames_other_items = [user.get(\\\"user\\\") for user in users_with_roles_other_items]\\n            emails_other_items = frappe.db.get_all(\\n                \\\"User\\\",\\n                filters={\\\"name\\\": [\\\"in\\\", usernames_other_items]},\\n                fields=[\\\"email\\\"]\\n            )\\n            email_list.extend([email.get(\\\"email\\\") for email in emails_other_items])\\n            email_list_other.extend([email.get(\\\"email\\\") for email in emails_other_items])\\n          \\nemail_list = list(set(email_list))\\nemail_string = \\\", \\\".join(email_list)\\nemail_list_other = list(set(email_list_other))\\nemail_string_other = \\\", \\\".join(email_list_other)\\nemail_list_time = list(set(email_list_time))\\nemail_string_time = \\\", \\\".join(email_list_time)\\n\\nif notification_subject:\\n    subject = \\\" | \\\".join(notification_subject)\\n    for user_entry in users_with_roles_time + users_with_roles_other_items:\\n        user = user_entry.get(\\\"user\\\")\\n        if user:\\n            notify = frappe.get_doc({\\n                \\\"doctype\\\": \\\"Notification Log\\\",\\n                \\\"subject\\\": subject,\\n                \\\"type\\\": \\\"Alert\\\",\\n                \\\"document_type\\\": \\\"Material Request\\\",\\n                \\\"document_name\\\": mr.name,\\n                \\\"for_user\\\": user,\\n                \\\"from_user\\\": frappe.session.user,\\n            })\\n            notify.insert(ignore_permissions=True)\\n\\nvariables[\\\"email_var\\\"] = email_string\\nvariables[\\\"email_var_time\\\"] = email_string_time\\nvariables[\\\"email_var_other\\\"] = email_string_other\\n\\n\",\"skip_queue_and_execute_immediately\":false,\"execute_current_node_as_user\":\"\",\"submit\":true,\"variable_path_for_output\":\"\"}",
      "position": "{\"x\":585,\"y\":75}",
      "type": "exec_python",
      "id": "Bs2zcZ6s0LL0DfaUJYsI9",
      "element_type": "Action",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g20dpm9j",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 3,
      "data": "{\"email_account\":\"\",\"select_template\":true,\"email_subject\":\"Test\",\"send_to_assigned_users\":false,\"recepients\":[{\"recepientField\":\"\",\"recipient\":\"\",\"cc\":\"\"}],\"link_doctype\":false,\"attach_prints\":false,\"submit\":true,\"recipients\":\"{{email_var_other}}\",\"cc\":\"\",\"bcc\":\"\",\"email_content\":\"<p>test</p>\",\"variable_path_for_output\":\"\",\"email_template\":\"Test\",\"createNewEmailTemplate\":false}",
      "position": "{\"x\":720,\"y\":225}",
      "type": "send_mail",
      "id": "DLkh_xfO2XrCkx9usOSZX",
      "element_type": "Action",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g24linlv",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 3,
      "data": "{\"email_account\":\"\",\"select_template\":true,\"email_subject\":\"Test\",\"send_to_assigned_users\":false,\"recepients\":[{\"recepientField\":\"\",\"recipient\":\"\",\"cc\":\"\"}],\"link_doctype\":false,\"attach_prints\":false,\"submit\":true,\"recipients\":\"{{email_var_time}}\",\"cc\":\"\",\"bcc\":\"\",\"email_content\":\"<p>test</p>\",\"variable_path_for_output\":\"\",\"email_template\":\"Test\",\"createNewEmailTemplate\":false}",
      "position": "{\"x\":450,\"y\":225}",
      "type": "send_mail",
      "id": "Yffly-xSATl1Ar48EI_X_",
      "element_type": "Action",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g2leltia",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 4,
      "data": "{\"node_label\":\"filter service\",\"use_python_expression\":true,\"submit\":true,\"expression\":\"doc = variables[\\\"doc\\\"]\\nif doc.custom_service == \\\"Tyre Hotel\\\":\\n    return True\\nelse:\\n    return False\",\"filters\":[],\"variable_path_for_output\":\"\"}",
      "position": "{\"x\":585,\"y\":-15}",
      "type": "var_filter",
      "id": "0uuxhxtH7E9zMuHLsOO1w",
      "element_type": "Action",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g27i1pf3",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 5,
      "type": "smoothstep",
      "id": "reactflow__edge-Bs2zcZ6s0LL0DfaUJYsI9output-DLkh_xfO2XrCkx9usOSZXinput",
      "element_type": "edge",
      "targethandle": "input",
      "target": "DLkh_xfO2XrCkx9usOSZX",
      "sourcehandle": "output",
      "source": "Bs2zcZ6s0LL0DfaUJYsI9",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g2v2gmuq",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 6,
      "data": "{\"submit\":true,\"variable_path_for_output\":\"\"}",
      "position": "{\"x\":1215,\"y\":405}",
      "type": "stop_current_workflow",
      "id": "j4RW4avA472P21FGCy07g",
      "element_type": "Action",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g2992m36",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 7,
      "type": "smoothstep",
      "id": "reactflow__edge-6xG08pb-28ylYWEwHqcaRoutput-0uuxhxtH7E9zMuHLsOO1winput",
      "element_type": "edge",
      "targethandle": "input",
      "target": "0uuxhxtH7E9zMuHLsOO1w",
      "sourcehandle": "output",
      "source": "6xG08pb-28ylYWEwHqcaR",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g2kosq3d",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 8,
      "type": "smoothstep",
      "id": "reactflow__edge-0uuxhxtH7E9zMuHLsOO1wyes-Bs2zcZ6s0LL0DfaUJYsI9input",
      "element_type": "edge",
      "targethandle": "input",
      "target": "Bs2zcZ6s0LL0DfaUJYsI9",
      "sourcehandle": "yes",
      "source": "0uuxhxtH7E9zMuHLsOO1w",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g2126v6i",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 9,
      "type": "smoothstep",
      "id": "reactflow__edge-0uuxhxtH7E9zMuHLsOO1wno-j4RW4avA472P21FGCy07ginput",
      "element_type": "edge",
      "targethandle": "input",
      "target": "j4RW4avA472P21FGCy07g",
      "sourcehandle": "no",
      "source": "0uuxhxtH7E9zMuHLsOO1w",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    },
    {
      "name": "j2g2cfied6",
      "owner": "Administrator",
      
      "modified_by": "Administrator",
      "docstatus": 0,
      "idx": 11,
      "type": "smoothstep",
      "id": "reactflow__edge-Bs2zcZ6s0LL0DfaUJYsI9output-Yffly-xSATl1Ar48EI_X_input",
      "element_type": "edge",
      "targethandle": "input",
      "target": "Yffly-xSATl1Ar48EI_X_",
      "sourcehandle": "output",
      "source": "Bs2zcZ6s0LL0DfaUJYsI9",
      "parent": "Material Request Notification TH1",
      "parentfield": "funnel_definition",
      "parenttype": "Funnel",
      "doctype": "Funnel Definition"
    }
  ],
  "__last_sync_on": "2024-12-27T12:35:10.404Z"
}